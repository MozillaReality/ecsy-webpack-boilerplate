!function(e){var t={};function n(s){if(t[s])return t[s].exports;var o=t[s]={i:s,l:!1,exports:{}};return e[s].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,s){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(s,o,function(t){return e[t]}.bind(null,o));return s},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";n.r(t);class s{constructor(e){this._systems=[],this._executeSystems=[],this.world=e}registerSystem(e,t){var n=new e(this.world,t);return n.init&&n.init(),n.order=this._systems.length,this._systems.push(n),n.execute&&this._executeSystems.push(n),this.sortSystems(),this}sortSystems(){this._executeSystems.sort((e,t)=>e.priority-t.priority||e.order-t.order)}getSystem(e){return this._systems.find(t=>t instanceof e)}getSystems(){return this._systems}removeSystem(e){var t=this._systems.indexOf(e);~t&&this._systems.splice(t,1)}execute(e,t){this._executeSystems.forEach(n=>{if(n.enabled&&n.initialized){if(n.canExecute()){let s=performance.now();n.execute(e,t),n.executeTime=performance.now()-s}n.clearEvents()}})}stats(){for(var e={numSystems:this._systems.length,systems:{}},t=0;t<this._systems.length;t++){var n=this._systems[t],s=e.systems[n.constructor.name]={queries:{}};for(var o in n.ctx)s.queries[o]=n.ctx[o].stats()}return e}}class o{constructor(){this._listeners={},this.stats={fired:0,handled:0}}addEventListener(e,t){let n=this._listeners;void 0===n[e]&&(n[e]=[]),-1===n[e].indexOf(t)&&n[e].push(t)}hasEventListener(e,t){return void 0!==this._listeners[e]&&-1!==this._listeners[e].indexOf(t)}removeEventListener(e,t){var n=this._listeners[e];if(void 0!==n){var s=n.indexOf(t);-1!==s&&n.splice(s,1)}}dispatchEvent(e,t,n){this.stats.fired++;var s=this._listeners[e];if(void 0!==s)for(var o=s.slice(0),i=0;i<o.length;i++)o[i].call(this,t,n)}resetCounters(){this.stats.fired=this.stats.handled=0}}function i(e){return e.name}function r(e){var t=i(e);return t.charAt(0).toLowerCase()+t.slice(1)}function a(e){for(var t=[],n=0;n<e.length;n++){var s=e[n];if("object"==typeof s){var o="not"===s.operator?"!":s.operator;t.push(o+i(s.Component))}else t.push(i(s))}return t.map((function(e){return e.toLowerCase()})).sort().join("-")}class h{constructor(e,t){if(this.Components=[],this.NotComponents=[],e.forEach(e=>{"object"==typeof e?this.NotComponents.push(e.Component):this.Components.push(e)}),0===this.Components.length)throw new Error("Can't create a query without components");this.entities=[],this.eventDispatcher=new o,this.reactive=!1,this.key=a(e);for(var n=0;n<t._entities.length;n++){var s=t._entities[n];this.match(s)&&(s.queries.push(this),this.entities.push(s))}}addEntity(e){e.queries.push(this),this.entities.push(e),this.eventDispatcher.dispatchEvent(h.prototype.ENTITY_ADDED,e)}removeEntity(e){let t=this.entities.indexOf(e);~t&&(this.entities.splice(t,1),t=e.queries.indexOf(this),e.queries.splice(t,1),this.eventDispatcher.dispatchEvent(h.prototype.ENTITY_REMOVED,e))}match(e){return e.hasAllComponents(this.Components)&&!e.hasAnyComponents(this.NotComponents)}stats(){return{numComponents:this.Components.length,numEntities:this.entities.length}}}h.prototype.ENTITY_ADDED="Query#ENTITY_ADDED",h.prototype.ENTITY_REMOVED="Query#ENTITY_REMOVED",h.prototype.COMPONENT_CHANGED="Query#COMPONENT_CHANGED";var m=0;class p{constructor(e){this._world=e||null,this.id=m++,this._ComponentTypes=[],this._components={},this._componentsToRemove={},this.queries=[],this._ComponentTypesToRemove=[],this.alive=!1}getComponent(e){return this._components[e.name]}getRemovedComponent(e){return this._componentsToRemove[e.name]}getComponents(){return this._components}getComponentsToRemove(){return this._componentsToRemove}getComponentTypes(){return this._ComponentTypes}getMutableComponent(e){for(var t=this._components[e.name],n=0;n<this.queries.length;n++){var s=this.queries[n];s.reactive&&-1!==s.Components.indexOf(e)&&s.eventDispatcher.dispatchEvent(h.prototype.COMPONENT_CHANGED,this,t)}return t}addComponent(e,t){return this._world.entityAddComponent(this,e,t),this}removeComponent(e,t){return this._world.entityRemoveComponent(this,e,t),this}hasComponent(e){return!!~this._ComponentTypes.indexOf(e)}hasRemovedComponent(e){return!!~this._ComponentTypesToRemove.indexOf(e)}hasAllComponents(e){for(var t=0;t<e.length;t++)if(!this.hasComponent(e[t]))return!1;return!0}hasAnyComponents(e){for(var t=0;t<e.length;t++)if(this.hasComponent(e[t]))return!0;return!1}removeAllComponents(e){return this._world.entityRemoveAllComponents(this,e)}reset(){this.id=m++,this._world=null,this._ComponentTypes.length=0,this.queries.length=0,this._components={}}remove(e){return this._world.removeEntity(this,e)}}class l{constructor(e,t){this.freeList=[],this.count=0,this.T=e;var n=null;arguments.length>1&&(n=Array.prototype.slice.call(arguments)).shift(),this.createElement=n?()=>new e(...n):()=>new e,void 0!==t&&this.expand(t)}aquire(){return this.freeList.length<=0&&this.expand(Math.round(.2*this.count)+1),this.freeList.pop()}release(e){e.reset(),this.freeList.push(e)}expand(e){for(var t=0;t<e;t++)this.freeList.push(this.createElement());this.count+=e}totalSize(){return this.count}totalFree(){return this.freeList.length}totalUsed(){return this.count-this.freeList.length}}class c{constructor(e){this._world=e,this._queries={}}onEntityRemoved(e){for(var t in this._queries){var n=this._queries[t];-1!==e.queries.indexOf(n)&&n.removeEntity(e)}}onEntityComponentAdded(e,t){for(var n in this._queries){var s=this._queries[n];~s.NotComponents.indexOf(t)&&~s.entities.indexOf(e)?s.removeEntity(e):~s.Components.indexOf(t)&&s.match(e)&&!~s.entities.indexOf(e)&&s.addEntity(e)}}onEntityComponentRemoved(e,t){for(var n in this._queries){var s=this._queries[n];~s.NotComponents.indexOf(t)&&!~s.entities.indexOf(e)&&s.match(e)?s.addEntity(e):~s.Components.indexOf(t)&&~s.entities.indexOf(e)&&!s.match(e)&&s.removeEntity(e)}}getQuery(e){var t=a(e),n=this._queries[t];return n||(this._queries[t]=n=new h(e,this._world)),n}stats(){var e={};for(var t in this._queries)e[t]=this._queries[t].stats();return e}}class u{}class d{constructor(e){this.world=e,this.componentsManager=e.componentsManager,this._entities=[],this._queryManager=new c(this),this.eventDispatcher=new o,this._entityPool=new l(p),this.entitiesWithComponentsToRemove=[],this.entitiesToRemove=[],this.numStateComponents=0}createEntity(){var e=this._entityPool.aquire();return e.alive=!0,e._world=this,this._entities.push(e),this.eventDispatcher.dispatchEvent(y,e),e}entityAddComponent(e,t,n){if(!~e._ComponentTypes.indexOf(t)){e._ComponentTypes.push(t),t.__proto__===u&&this.numStateComponents++;var s=this.world.componentsManager.getComponentsPool(t).aquire();if(e._components[t.name]=s,n)if(s.copy)s.copy(n);else for(var o in n)s[o]=n[o];this._queryManager.onEntityComponentAdded(e,t),this.world.componentsManager.componentAddedToEntity(t),this.eventDispatcher.dispatchEvent(f,e,t)}}entityRemoveComponent(e,t,n){var s=e._ComponentTypes.indexOf(t);if(~s){if(this.eventDispatcher.dispatchEvent(_,e,t),n)this._entityRemoveComponentSync(e,t,s);else{0===e._ComponentTypesToRemove.length&&this.entitiesWithComponentsToRemove.push(e),e._ComponentTypes.splice(s,1),e._ComponentTypesToRemove.push(t);var o=i(t);e._componentsToRemove[o]=e._components[o],delete e._components[o]}this._queryManager.onEntityComponentRemoved(e,t),t.__proto__===u&&(this.numStateComponents--,0!==this.numStateComponents||e.alive||e.remove())}}_entityRemoveComponentSync(e,t,n){e._ComponentTypes.splice(n,1);var s=r(t),o=i(t),a=e._components[o];delete e._components[o],this.componentsManager._componentPool[s].release(a),this.world.componentsManager.componentRemovedFromEntity(t)}entityRemoveAllComponents(e,t){let n=e._ComponentTypes;for(let s=n.length-1;s>=0;s--)n[s].__proto__!==u&&this.entityRemoveComponent(e,n[s],t)}removeEntity(e,t){var n=this._entities.indexOf(e);if(!~n)throw new Error("Tried to remove entity not in list");e.alive=!1,0===this.numStateComponents&&(this.eventDispatcher.dispatchEvent(v,e),this._queryManager.onEntityRemoved(e),!0===t?this._releaseEntity(e,n):this.entitiesToRemove.push(e)),this.entityRemoveAllComponents(e,t)}_releaseEntity(e,t){this._entities.splice(t,1),e._world=null,this._entityPool.release(e)}removeAllEntities(){for(var e=this._entities.length-1;e>=0;e--)this.removeEntity(this._entities[e])}processDeferredRemoval(){for(let e=0;e<this.entitiesToRemove.length;e++){let t=this.entitiesToRemove[e],n=this._entities.indexOf(t);this._releaseEntity(t,n)}this.entitiesToRemove.length=0;for(let s=0;s<this.entitiesWithComponentsToRemove.length;s++){let o=this.entitiesWithComponentsToRemove[s];for(;o._ComponentTypesToRemove.length>0;){let s=o._ComponentTypesToRemove.pop();var e=r(s),t=i(s),n=o._componentsToRemove[t];delete o._componentsToRemove[t],this.componentsManager._componentPool[e].release(n)}}this.entitiesWithComponentsToRemove.length=0}queryComponents(e){return this._queryManager.getQuery(e)}count(){return this._entities.length}stats(){var e={numEntities:this._entities.length,numQueries:Object.keys(this._queryManager._queries).length,queries:this._queryManager.stats(),numComponentPool:Object.keys(this.componentsManager._componentPool).length,componentPool:{},eventDispatcher:this.eventDispatcher.stats};for(var t in this.componentsManager._componentPool){var n=this.componentsManager._componentPool[t];e.componentPool[t]={used:n.totalUsed(),size:n.count}}return e}}const y="EntityManager#ENTITY_CREATE",v="EntityManager#ENTITY_REMOVED",f="EntityManager#COMPONENT_ADDED",_="EntityManager#COMPONENT_REMOVE";class g{constructor(e){this.count=0,this.used=0,this.T=e}aquire(){return this.used++,this.count++,new this.T}release(){this.used--}totalSize(){return this.count}totalFree(){return 1/0}totalUsed(){return this.used}}class C{constructor(){this.Components={},this._componentPool={},this.numComponents={}}registerComponent(e){this.Components[e.name]=e,this.numComponents[e.name]=0}componentAddedToEntity(e){this.numComponents[e.name]?this.numComponents[e.name]++:this.numComponents[e.name]=1}componentRemovedFromEntity(e){this.numComponents[e.name]--}getComponentsPool(e){var t=r(e);return this._componentPool[t]||(e.prototype.reset?this._componentPool[t]=new l(e):(console.warn(`Component '${e.name}' won't benefit from pooling because 'reset' method was not implemeneted.`),this._componentPool[t]=new g(e))),this._componentPool[t]}}class E{canExecute(){if(0===this._mandatoryQueries.length)return!0;for(let e=0;e<this._mandatoryQueries.length;e++){if(0===this._mandatoryQueries[e].entities.length)return!1}return!0}constructor(e,t){if(this.world=e,this.enabled=!0,this._queries={},this.queries={},this.priority=0,this.executeTime=0,t&&t.priority&&(this.priority=t.priority),this._mandatoryQueries=[],this.initialized=!0,this.constructor.queries)for(var n in this.constructor.queries){var s=this.constructor.queries[n],o=s.components;if(!o||0===o.length)throw new Error("'components' attribute can't be empty in a query");var i=this.world.entityManager.queryComponents(o);this._queries[n]=i,!0===s.mandatory&&this._mandatoryQueries.push(i),this.queries[n]={results:i.entities};const e={added:h.prototype.ENTITY_ADDED,removed:h.prototype.ENTITY_REMOVED,changed:h.prototype.COMPONENT_CHANGED};s.listen&&["added","removed","changed"].forEach(t=>{if(s.listen[t]){let o=s.listen[t];if("changed"===t){if(i.reactive=!0,!0===o){let e=this.queries[n][t]=[];i.eventDispatcher.addEventListener(h.prototype.COMPONENT_CHANGED,t=>{-1===e.indexOf(t)&&e.push(t)})}else if(Array.isArray(o)){let e=this.queries[n][t]=[];i.eventDispatcher.addEventListener(h.prototype.COMPONENT_CHANGED,(t,n)=>{-1!==o.indexOf(n.constructor)&&-1===e.indexOf(t)&&e.push(t)})}}else{let s=this.queries[n][t]=[];i.eventDispatcher.addEventListener(e[t],e=>{-1===s.indexOf(e)&&s.push(e)})}}})}}stop(){this.enabled=!1}play(){this.enabled=!0}clearEvents(){for(let t in this.queries){var e=this.queries[t];if(e.added&&(e.added.length=0),e.removed&&(e.removed.length=0),e.changed)if(Array.isArray(e.changed))e.changed.length=0;else for(let t in e.changed)e.changed[t].length=0}}toJSON(){return{name:this.constructor.name,enabled:this.enabled,executeTime:this.executeTime,priority:this.priority,queries:{}}}}class T{reset(){}}function x(e){var t=["create","reset","clear"].filter(t=>!e[t]);if(t.length>0)throw new Error(`createType expect type definition to implements the following functions: ${t.join(", ")}`);return e.isType=!0,e}var w={};w.Number=x({baseType:Number,isSimpleType:!0,create:e=>void 0!==e?e:0,reset:(e,t,n)=>{e[t]=void 0!==n?n:0},clear:(e,t)=>{e[t]=0}}),w.Boolean=x({baseType:Boolean,isSimpleType:!0,create:e=>void 0!==e&&e,reset:(e,t,n)=>{e[t]=void 0!==n&&n},clear:(e,t)=>{e[t]=!1}}),w.String=x({baseType:String,isSimpleType:!0,create:e=>void 0!==e?e:"",reset:(e,t,n)=>{e[t]=void 0!==n?n:""},clear:(e,t)=>{e[t]=""}}),w.Array=x({baseType:Array,create:e=>void 0!==e?e.slice():[],reset:(e,t,n)=>{void 0!==n?e[t]=n.slice():e[t].length=0},clear:(e,t)=>{e[t].length=0},copy:(e,t,n)=>{e[n]=t[n].slice()}});w.Number,w.Boolean,w.String;const M=.1,O=20,q=O/2;let R=document.querySelector("canvas"),b=R.width=window.innerWidth,S=R.height=window.innerHeight,D=R.getContext("2d");class N{constructor(){this.x=this.y=0}}class A{constructor(){this.x=this.y=0}}class P{constructor(){this.primitive="box"}}class L extends T{}class j extends E{execute(e,t){this.queries.moving.results.forEach(t=>{var n=t.getComponent(N),s=t.getMutableComponent(A);s.x+=n.x*e,s.y+=n.y*e,s.x>b+q&&(s.x=-q),s.x<-q&&(s.x=b+q),s.y>S+q&&(s.y=-q),s.y<-q&&(s.y=S+q)})}}j.queries={moving:{components:[N,A]}};class Q extends E{execute(e,t){D.globalAlpha=1,D.fillStyle="#ffffff",D.fillRect(0,0,b,S),this.queries.renderables.results.forEach(e=>{var t=e.getComponent(P),n=e.getComponent(A);"box"===t.primitive?this.drawBox(n):this.drawCircle(n)})}drawCircle(e){D.fillStyle="#888",D.beginPath(),D.arc(e.x,e.y,q,0,2*Math.PI,!1),D.fill(),D.lineWidth=1,D.strokeStyle="#222",D.stroke()}drawBox(e){D.beginPath(),D.rect(e.x-q,e.y-q,O,O),D.fillStyle="#f28d89",D.fill(),D.lineWidth=1,D.strokeStyle="#800904",D.stroke()}}Q.queries={renderables:{components:[L,P]}};var I=new class{constructor(){if(this.componentsManager=new C(this),this.entityManager=new d(this),this.systemManager=new s(this),this.enabled=!0,this.eventQueues={},"undefined"!=typeof CustomEvent){var e=new CustomEvent("ecsy-world-created",{detail:this});window.dispatchEvent(e)}}registerComponent(e){return this.componentsManager.registerComponent(e),this}registerSystem(e,t){return this.systemManager.registerSystem(e,t),this}getSystem(e){return this.systemManager.getSystem(e)}getSystems(){return this.systemManager.getSystems()}execute(e,t){this.enabled&&(this.systemManager.execute(e,t),this.entityManager.processDeferredRemoval())}stop(){this.enabled=!1}play(){this.enabled=!0}createEntity(){return this.entityManager.createEntity()}stats(){var e={entities:this.entityManager.stats(),system:this.systemManager.stats()};console.log(JSON.stringify(e,null,2))}};I.registerSystem(j).registerSystem(Q);for(let e=0;e<600;e++)I.createEntity().addComponent(N,{x:M*(2*Math.random()-1),y:M*(2*Math.random()-1)}).addComponent(P,{primitive:Math.random()>=.5?"circle":"box"}).addComponent(A,{x:Math.random()*b,y:Math.random()*S}).addComponent(L);var Y=performance.now();!function e(){var t=performance.now(),n=t-Y;I.execute(n,t),Y=t,requestAnimationFrame(e)}()}]);